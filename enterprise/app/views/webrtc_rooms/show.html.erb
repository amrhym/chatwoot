<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= @channel.welcome_title || 'Voice Call' %></title>
  <script src="https://unpkg.com/livekit-client@2.1.5/dist/livekit-client.umd.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fb;
      color: #1b2836;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 380px;
      padding: 20px;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 32px 24px;
    }
    .header {
      text-align: center;
      margin-bottom: 24px;
    }
    .header h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .header p {
      font-size: 14px;
      color: #6e7c87;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #394452;
    }
    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d3d6db;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .form-group input:focus {
      border-color: <%= @channel.widget_color || '#1f93ff' %>;
    }
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary {
      background: <%= @channel.widget_color || '#1f93ff' %>;
      color: #fff;
    }
    .btn-primary:hover:not(:disabled) { opacity: 0.9; }
    .btn-danger {
      background: #e74c3c;
      color: #fff;
    }
    .btn-danger:hover:not(:disabled) { opacity: 0.9; }

    /* Call UI */
    #call-view { display: none; text-align: center; }
    .call-status {
      font-size: 14px;
      color: #6e7c87;
      margin-bottom: 16px;
    }
    .timer {
      font-size: 32px;
      font-weight: 300;
      margin-bottom: 24px;
      font-variant-numeric: tabular-nums;
    }
    .participants {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin-bottom: 24px;
    }
    .participant {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    .avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: <%= @channel.widget_color || '#1f93ff' %>;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 600;
      position: relative;
    }
    .avatar .audio-indicator {
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #2ecc71;
      border: 2px solid #fff;
    }
    .avatar .audio-indicator.muted { background: #e74c3c; }
    .participant-name {
      font-size: 12px;
      color: #6e7c87;
      max-width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .call-controls {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 16px;
    }
    .call-control-btn {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }
    .call-control-btn:hover { transform: scale(1.1); }
    .call-control-btn svg { width: 24px; height: 24px; }
    .mute-btn { background: #e8ecf1; }
    .mute-btn.active { background: #e74c3c; }
    .mute-btn svg { fill: #394452; }
    .mute-btn.active svg { fill: #fff; }
    .end-btn { background: #e74c3c; }
    .end-btn svg { fill: #fff; }

    .error-msg {
      color: #e74c3c;
      font-size: 13px;
      margin-top: 8px;
      text-align: center;
    }
    .connecting { animation: pulse 1.5s ease infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <!-- Waiting Room Form -->
      <div id="waiting-room">
        <div class="header">
          <h2><%= @channel.welcome_title || 'Start a Voice Call' %></h2>
          <p><%= @channel.welcome_tagline || 'Enter your details to connect with our team' %></p>
        </div>
        <form id="join-form">
          <div class="form-group">
            <label for="name">Name *</label>
            <input type="text" id="name" required placeholder="Your name" />
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" placeholder="your@email.com" />
          </div>
          <div class="form-group">
            <label for="phone">Phone</label>
            <input type="tel" id="phone" placeholder="+1234567890" />
          </div>
          <button type="submit" class="btn btn-primary" id="join-btn">
            Start Call
          </button>
          <div id="error-msg" class="error-msg" style="display:none;"></div>
        </form>
      </div>

      <!-- Call View -->
      <div id="call-view">
        <div class="header">
          <h2>Voice Call</h2>
          <p id="call-status" class="call-status">Connecting...</p>
        </div>
        <div class="timer" id="call-timer">00:00</div>
        <div class="participants" id="participants"></div>
        <div class="call-controls">
          <button class="call-control-btn mute-btn" id="mute-btn" title="Toggle mute">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14a3 3 0 003-3V5a3 3 0 00-6 0v6a3 3 0 003 3zm-1-9a1 1 0 012 0v6a1 1 0 01-2 0V5zM19 11a1 1 0 00-2 0 5 5 0 01-10 0 1 1 0 00-2 0 7 7 0 006 6.93V20H8a1 1 0 000 2h8a1 1 0 000-2h-3v-2.07A7 7 0 0019 11z"/></svg>
          </button>
          <button class="call-control-btn end-btn" id="end-btn" title="End call">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.956.956 0 010-1.36C3.42 8.63 7.5 7 12 7s8.58 1.63 11.71 4.72c.18.18.29.44.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28a11.3 11.3 0 00-2.67-1.85.996.996 0 01-.56-.9v-3.1A15.9 15.9 0 0012 9z"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const TOKEN = '<%= @channel.website_token %>';
      const BASE_URL = window.location.origin;
      let room = null;
      let timerInterval = null;
      let callSeconds = 0;
      let isMuted = false;

      const joinForm = document.getElementById('join-form');
      const waitingRoom = document.getElementById('waiting-room');
      const callView = document.getElementById('call-view');
      const joinBtn = document.getElementById('join-btn');
      const muteBtn = document.getElementById('mute-btn');
      const endBtn = document.getElementById('end-btn');
      const callTimer = document.getElementById('call-timer');
      const callStatus = document.getElementById('call-status');
      const participantsEl = document.getElementById('participants');
      const errorMsg = document.getElementById('error-msg');

      joinForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        errorMsg.style.display = 'none';
        joinBtn.disabled = true;
        joinBtn.textContent = 'Connecting...';
        joinBtn.classList.add('connecting');

        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;

        try {
          const res = await fetch(BASE_URL + '/webrtc/room/join', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: TOKEN, name: name, email: email, phone: phone })
          });

          if (!res.ok) {
            const data = await res.json();
            throw new Error(data.error || 'Failed to join call');
          }

          const data = await res.json();
          window._webrtcConversationId = data.conversation_id;
          window._webrtcRoomName = data.room_name;

          await connectToRoom(data.url, data.token, name);
        } catch (err) {
          errorMsg.textContent = err.message;
          errorMsg.style.display = 'block';
          joinBtn.disabled = false;
          joinBtn.textContent = 'Start Call';
          joinBtn.classList.remove('connecting');
        }
      });

      async function connectToRoom(wsUrl, token, name) {
        const LivekitClient = window.LivekitClient;
        room = new LivekitClient.Room({
          audioCaptureDefaults: { echoCancellation: true, noiseSuppression: true, autoGainControl: true },
          publishDefaults: { audioPreset: LivekitClient.AudioPresets.music }
        });

        room.on(LivekitClient.RoomEvent.ParticipantConnected, updateParticipants);
        room.on(LivekitClient.RoomEvent.ParticipantDisconnected, updateParticipants);
        room.on(LivekitClient.RoomEvent.TrackSubscribed, updateParticipants);
        room.on(LivekitClient.RoomEvent.TrackUnsubscribed, updateParticipants);
        room.on(LivekitClient.RoomEvent.TrackMuted, updateParticipants);
        room.on(LivekitClient.RoomEvent.TrackUnmuted, updateParticipants);
        room.on(LivekitClient.RoomEvent.Disconnected, handleDisconnect);

        await room.connect(wsUrl, token);
        await room.localParticipant.setMicrophoneEnabled(true);

        waitingRoom.style.display = 'none';
        callView.style.display = 'block';
        callStatus.textContent = 'Connected';
        startTimer();
        updateParticipants();
      }

      function updateParticipants() {
        if (!room) return;
        participantsEl.innerHTML = '';

        const addParticipant = (name, isMuted) => {
          const div = document.createElement('div');
          div.className = 'participant';
          const initial = (name || '?')[0].toUpperCase();
          div.innerHTML = '<div class="avatar">' + initial +
            '<span class="audio-indicator ' + (isMuted ? 'muted' : '') + '"></span></div>' +
            '<span class="participant-name">' + (name || 'Unknown') + '</span>';
          participantsEl.appendChild(div);
        };

        // Local participant
        const localMuted = !room.localParticipant.isMicrophoneEnabled;
        addParticipant(room.localParticipant.identity + ' (You)', localMuted);

        // Remote participants
        room.remoteParticipants.forEach(function(participant) {
          let remoteMuted = true;
          participant.audioTrackPublications.forEach(function(pub) {
            if (pub.track && !pub.isMuted) remoteMuted = false;
          });
          addParticipant(participant.identity, remoteMuted);
        });

        const count = room.remoteParticipants.size;
        if (count === 0) {
          callStatus.textContent = 'Waiting for agent...';
        } else {
          callStatus.textContent = count + ' participant' + (count > 1 ? 's' : '') + ' connected';
        }
      }

      muteBtn.addEventListener('click', async function() {
        if (!room) return;
        isMuted = !isMuted;
        await room.localParticipant.setMicrophoneEnabled(!isMuted);
        muteBtn.classList.toggle('active', isMuted);
        updateParticipants();
      });

      endBtn.addEventListener('click', function() {
        endCall();
      });

      function handleDisconnect() {
        endCall(true);
      }

      async function endCall(alreadyDisconnected) {
        stopTimer();
        if (room && !alreadyDisconnected) {
          room.disconnect();
        }
        room = null;

        try {
          await fetch(BASE_URL + '/webrtc/room/leave', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              token: TOKEN,
              room_name: window._webrtcRoomName,
              conversation_id: window._webrtcConversationId
            })
          });
        } catch (e) { /* ignore cleanup errors */ }

        callView.style.display = 'none';
        waitingRoom.style.display = 'block';
        joinBtn.disabled = false;
        joinBtn.textContent = 'Start Call';
        joinBtn.classList.remove('connecting');
        callSeconds = 0;
        callTimer.textContent = '00:00';
      }

      function startTimer() {
        callSeconds = 0;
        timerInterval = setInterval(function() {
          callSeconds++;
          const m = String(Math.floor(callSeconds / 60)).padStart(2, '0');
          const s = String(callSeconds % 60).padStart(2, '0');
          callTimer.textContent = m + ':' + s;
        }, 1000);
      }

      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }
    })();
  </script>
</body>
</html>
